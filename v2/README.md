# 2.0 接入指南

> 修订中

## 一、 接入流程  

1. 注册商户

在商户平台注册，注册成功后填写必要的信息，请确保您的注册信息真实有效。我们会尽快完成审核;

2. 审核通过后，在后台获取接入参数，开始接入系统;

4. 在接入过程中如有问题，请联系我们;

## 二、 服务端接入
### 简介

| 接口名称 | 接口说明 | 详细说明 |
| -- | -- | --|
| 下单 | 商户需要先调用此接口来获取支付信息 | 详细说明 |
| 交易结果回调通知 | 支付完成后平台会通过此接口向商户后台发送支付结果通知 | 详细说明 |
| 交易结果主动查询 | 商户在下单后可调用此接口查询支付结果;| 详细说明 |

### 接口说明
1. 接口均使用 `Method: POST` , `Content-Type:application/json`;
2. 数据传输的时候参数值需要进行urlencode编码;
3. 商户需要使用在商户后台获取的私钥对参数加密;

### 下单

用户在购买商品时， 商户需先通过本接口进行下单, 下单成功后平台会返回交易流水号及必要的支付信息，用户通过支付信息来完成支付操作。  
订单有效支付时间为`2分钟`，两分钟后用户已支付但订单状态没有完成，请联系我们，复核此订单。

##### Request:

POST: `http://0.0.0.0/3210/payapi/v2/orders`  

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid | Integer |必填 | 平台分配的商户编号 |
| orderid | String(32) | 必填 | 商户生成的订单号需要保证系统唯一平台分配的商户编号 |
| price | Integer | 必填 | 支付金额，单位(分) |
| payment | Integer | 必填 | 支付通道。 100:支付宝; 200:微信 |
| currency | String(32) | 必填 | 货币类型，目前仅支持人民币: "RMB"|
| notifyurl | String(128) | 必填 | 商户服务端接收支付结果通知地址 |
| returnurl | String(128) | 可选 | 使用平台页面支付完成后会调转到此页面|
| goosname | String(32) | 可选 | 消费商品的名称，不填平台会默认设置一个商品名称"1.00元"|
| extra | String(64)| 可选 | 透传信息，支付完成后会将此信息透传给商户|
| sign | String(32) | 必填 | 对参数签名数据 |
| signtype | String(32) | 必填 | 签名算法类型，目前仅支持"md5"|

sign 加密示例:
params = 参数以ASCII升序排列并以`&`拼接
sign = md5(params + secret)

##### Response:

``` js
// SUCCESS
{
    "code": "1", 
    "msg": "success",
    "data":{
        "transid": "201801",    // 交易流水号
        "key" : "abcdef",       // 订单有效性验证，主动查询订单时需要传回此参数
        "url" : "HTTP://",      // 实际支付地址
        "sign": "abcdefg",      // 签名
        "signtype": "md5"       // 签名算法类型
    }
}
// FAIL
{
    "code":"-18",
    "msg" :"商户key 验证失败"
}
```



### 交易结果回调通知
用户完成支付后，平台使用商户在下单接口中传入的`notifyurl`,向商户发送支付结果。

#### Request:
POST: notifyurl

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid | Integer |必填 | 平台分配的商户编号 |
| orderid | String(32) | 必填 | 商户生成的订单号需要保证系统唯一平台分配的商户编号 |
| transid| String(32) | 必填 | 平台订单流水号|
| transtime| String(32) | 必填 | 交易完成时间，时间戳(秒)|
| price | Integer | 必填 | 本次交易的金额，请严格匹配金额是否与订单金额一致 |
| payment | Integer | 必填 | 支付通道。 100:支付宝; 200:微信 |
| currency | String(32) | 必填 | 货币类型，目前仅支持人民币: "RMB"|
| extra | String(64)| 可选 | 透传信息，支付完成后会将此信息透传给商户|
| status | String(2) | 必填 | 交易结果, 1:未支付; 2: 已支付 |
| sign | String(32) | 必填 | 对参数签名数据 |
| signtype | String(32) | 必填 | 签名算法类型，目前仅支持"md5"|

#### Response: 
``` js
//SUCCESS

返回数据为 success

//FAIL
返回数据不为 success

```

### 交易结果主动查询
交易完成后，商户主动向平台查询交易结果。此接口查询有时效及访问次数限制.

##### Request:

POST: `http://0.0.0.0/3210/payapi/v2/query`  

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid | Integer |必填 | 平台分配的商户编号 |
| key | String(32) | 必填 | 在下单时，平台返回的key|
| orderid | String(32) | 必填 | 商户订单号|
| sign | String(32) | 必填 | 对参数签名数据 |
| signtype | String(32) | 必填 | 签名算法类型，目前仅支持"md5"|

#### Response:

``` js
// SUCCESS
{
    "code": "1", 
    "msg": "success",
    "data":{
        "uid" : "123456",
        "orderid": "",
        "transid": "201801",    // 交易流水号
        "transtime":"",         // 交易完成时间，时间戳(秒)
        "price":"",             // 本次交易的金额，请严格匹配金额是否与订单金额一致
        "payment":"100",        // 支付通道。 100:支付宝; 200:微信 
        "currency":"RMB",       // 货币类型
        "extra":"",             // 透传信息，支付完成后会将此信息透传给商户 
        "status":"2",           // 交易结果, 1:未支付; 2: 已支付
        "sign": "abcdefg",      // 签名
        "signtype": "md5"       // 签名算法类型
    }
}
// FAIL
{
    "code":"-18",
    "msg" :"商户key 验证失败"
}
```

### 交易金额

目前仅支持规定金额交易  

| 名称 | price(分) |
| -- | -- |
| 10 元| 1000 |
| 20 元| 2000 |
| 100 元| 10000 |

### 错误码

| 错误码  | 注释  | 检查方法 |
|--|--| -- |
|-18 | 商户key 验证失败 | 请检查私钥是否正确及参数拼接顺序是否正确|
|-19 | 商户号不可用 | 请联系我们为您开通功能 |
|-20 | 系统没有可分配的二维码,请稍后再试 | 请检查传入的金额是否为金额列表中的金额 |
|-32 | 商户验证失败,请确认商户是否正常或者参数是否正确 |
|-34 | 系统繁忙,当前用户获取请求太频繁 |
|-36 | 当前用户被设置成黑名单,请联系平台。|
|-37 | 当前IP不是商户的白名单|
|-38 | 商户端系统错误|
|-39 | 商户异常|
|-44 | 重复提交|
