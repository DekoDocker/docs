# 2.0 接入指南

> 2018-08-27 更新下单接口

## 一、 接入流程  

1. 注册商户

在商户平台注册，注册成功后填写必要的信息，请确保您的注册信息真实有效。我们会尽快完成审核;

2. 审核通过后，在后台获取接入参数，开始接入系统;

4. 在接入过程中如有问题，请联系我们;

### 简介
| 名称 | 描述 | 详细说明 |
| -- | -- | --|
| 下单 | 商户需要先调用此接口来获取支付信息 | [详细说明](#%E4%B8%8B%E5%8D%95) |
| 交易结果回调通知 | 支付完成后平台会通过此接口向商户后台发送支付结果通知 | [详细说明](#交易结果回调通知) |
| 交易结果主动查询 | 商户在下单后可调用此接口查询支付结果;| [详细说明](#交易结果主动查询) |
| 交易金额 | 支持交易的固定金额;| [详细说明](#交易金额) |
| 错误码 | 平台返回的错误码含义| [详细说明](#错误码) |

## 二、 服务端接入
### 接口说明
1. 接口均使用 `Method: POST` , `Content-Type:application/json`;
2. 商户需要使用在商户后台获取的私钥对参数加密;

### 下单

用户在购买商品时， 商户需先通过本接口进行下单, 下单成功后平台会返回交易流水号及必要的支付信息，用户通过支付信息来完成支付操作。  
订单有效支付时间为`2分钟`，两分钟后用户已支付但订单状态没有完成，请联系我们，复核此订单。

##### Request:

POST: `http://0.0.0.0/3210/payapi/v2/orders`  

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid |  String(20) |必填 | 平台分配的商户编号 |
| orderid | String(20) | 必填 | 商户生成的订单号需要保证系统唯一平台分配的商户编号 |
| orderuid | String(20) | 选填 | 商户的用户ID，显示在商户后台中，方便对账|
| price |  String(20) | 必填 | 支付金额，单位(分) |
| paytype|  String(3) | 必填 | 支付通道。 100:支付宝; 200:微信 |
| notifyurl | String(128) | 必填 | 商户服务端接收支付结果通知地址 |
| returnurl | String(128) | 可选 | 使用平台页面支付完成后会调转到此页面|
| goodsname | String(20) | 可选 | 消费商品的名称，不填平台会默认设置一个商品名称"1.00元",注: 请合理传商品长度,此名称会显示在支付页面。|
| extra | String(64)| 可选 | 透传信息，支付完成后会将此信息透传给商户|
| key | String(32) | 必填 | 对参数签名数据.|

key 加密示例:  
params = 参数以ASCII升序排列并以`&`拼接  
key = md5(params + secret)  

##### Response:

``` js
// SUCCESS
{
    "code": "1", 
    "msg": "success",
    "err_msg": "no msg",
    "data":{
        "result": {
            "transid": "180802154912355",                                                                       // 交易流水号
            "orderid": "123456",                                                                                // 商户订单号
            "paytype": "200",                                                                                   // 支付类型
            "price": "1000",                                                                                    // 金额
            "url": "http://0.0.0.0/wap/pay/6a3757876353bca37acae9c4faa6958e/22c068a6ef800f6b5416b10c2c982cd6",  // 拉起APP链接
            "qrurl": "http://0.0.0.0/wap/pay/6a3757876353bca37acae9c4faa6958e/22c068a6ef800f6b5416b10c2c982cd6",// 二维码H5订单页面
            "goodsname": "rmb",                                                                                 // 商品名称
            "transtime": "2018-08-02 15:49:12"                                                                  // 订单生成时间
        }
    }
    // url 与 qrurl 区别
    // qrurl 为二维码H5的通用地址,微信及支付宝都可使用此地址完成支付功能。(适用于 PC，mobile)
    // url 为支付解析地址， 支付宝可通过解析地址直接拉起手机内的支付宝APP完成支付， 微信暂不支持此功能返回的仍然是H5支付页面。(仅适用于 mobile)
    // url 参数使用时需要 UrlDecode 解码
}

// FAIL
{
    "code":"-18",
    "msg" :"商户key 验证失败",
    "err_msg":"Error:Field validation for 'NotifyURL'",
    "data": {}
}
```



### 交易结果回调通知
用户完成支付后，平台使用商户在下单接口中传入的`notifyurl`,向商户发送支付结果。  
回调结果至少会发送1次, 如调用商户接口失败，会在第 `10`秒 及 第`30` 秒再次调用两次。

#### Request:
POST: notifyurl

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid | String(20) |必填 | 平台分配的商户编号 |
| orderid | String(20) | 必填 | 商户生成的订单号需要保证系统唯一平台分配的商户编号 |
| transid| String(20) | 必填 | 平台订单流水号|
| transtime| String(20) | 必填 | 交易完成时间，时间戳(秒)|
| price | String(20) | 必填 | 本次交易的金额，请严格匹配金额是否与订单金额一致 |
| paytype | String(3)| 必填 | 支付通道。 100:支付宝; 200:微信 |
| extra | String(64)| 可选 | 透传信息，支付完成后会将此信息透传给商户|
| status | String(2) | 必填 | 交易结果, 1:未支付; 2: 已支付 |
| key | String(32) | 必填 | 对参数签名数据 |
| version | String(4) | 必填 | 版本号，商户根据版本号处理不同版本的回调(2)|

#### Response: 
``` js
//SUCCESS
商户成功接收到支付结果通知之后，http body 数据为 `SUCCESS`  

若返回数据非`SUCCESS`，则视为失败

```

### 交易结果主动查询
交易完成后，商户主动向平台查询交易结果。此接口查询有时效及访问次数限制.

##### Request:

POST: `http://0.0.0.0/3210/payapi/v2/query`  

| 参数名称 | 类型 | 是否可选 | 说明 |
| -- | -- | -- | -- |  
| uid | String(20) |必填 | 平台分配的商户编号 |
| transid | String(20) | 必填| 平台流水单号|
| key | String(32) | 必填 | 对参数签名数据 |

#### Response:

``` js
// SUCCESS
{
    "code": "1", 
    "msg": "success",
    "errt_msg": "no msg",
    "data":{
         "result": {
            "transid": "201801",    // 交易流水号
            "orderid": "123456",    // 商户订单号
            "price":"100",          // 本次交易的金额，请严格匹配金额是否与订单金额一致
            "paytype":"100",        // 支付通道。 100:支付宝; 200:微信 
            "status":"2",           // 交易结果, 1:未支付; 2: 已支付
            "transtime":"",         // 交易时间
         }
    }
}
// FAIL
{
    "code":"-18",
    "msg" :"商户key 验证失败"
}
```

### 交易金额

目前仅支持规定金额交易, 如传入的price不在一下列表中，会返回`code = -20`;(具体支持金额，请咨询客服)

| 名称 | price(分) |
| -- | -- |
| 10 元| 1000 |
| 20 元| 2000 |
| 100 元| 10000 |


### 错误码

| 错误码  | 注释  | 检查方法 |
|--|--| -- |
|-7  | 参数错误，请确认参数是否正确 | 请检查必传参数是否已成功传参|
|-18 | 商户key 验证失败 | 请检查私钥是否正确及参数拼接顺序是否正确|
|-19 | 商户号不可用 | 请联系我们为您开通功能 |
|-20 | 系统没有可分配的二维码,请稍后再试 | 请检查传入的金额是否为金额列表中的金额 |
|-32 | 商户验证失败,请确认商户是否正常或者参数是否正确 |
|-34 | 系统繁忙,当前用户获取请求太频繁 |
|-36 | 当前用户被设置成黑名单,请联系平台。|
|-37 | 当前IP不是商户的白名单|
|-38 | 商户端系统错误|
|-39 | 商户异常|
|-44 | 重复提交|
